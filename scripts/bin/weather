#!/bin/bash

OWM_KEY=$1

if [[ $OWM_KEY == "" ]]
then
    echo "You forgot adding the OpenWeatherMap API key as an argument"
    exit 1
fi

function map_weather_code_to_emoji() {
    local code=$1

    case $code in
        "01d") echo "‚òÄÔ∏è" ;;        # Sunny
        "01n") echo "üåô" ;;       # Clear Night
        "02d") echo "‚õÖÔ∏è" ;;       # Partly Cloudy Day
        "02n") echo "‚òÅÔ∏è" ;;        # Partly Cloudy Night
        "03d") echo "üå§Ô∏è" ;;        # Scattered Clouds Day
        "03n") echo "üå§Ô∏è" ;;        # Scattered Clouds Night
        "04d") echo "‚òÅÔ∏è" ;;        # Cloudy Day
        "04n") echo "‚òÅÔ∏è" ;;        # Cloudy Night
        "09d") echo "üåßÔ∏è" ;;        # Rainy Day
        "09n") echo "üåßÔ∏è" ;;        # Rainy Night
        "10d") echo "üå¶Ô∏è" ;;        # Rainy Day
        "10n") echo "üå¶Ô∏è" ;;        # Rainy Night
        "11d") echo "‚õàÔ∏è" ;;        # Thunderstorm Day
        "11n") echo "‚õàÔ∏è" ;;        # Thunderstorm Night
        "13d") echo "‚ùÑÔ∏è" ;;        # Snowy Day
        "13n") echo "‚ùÑÔ∏è" ;;        # Snowy Night
        "50d") echo "üå´Ô∏è" ;;        # Misty Day
        "50n") echo "üå´Ô∏è" ;;        # Misty Night
        *) echo "‚ùì" ;;           # Unknown or unsupported code
    esac
}

CITY=$(curl -s http://ip-api.com/json | jq -r .city)
LOCATION=$(curl -s -X GET "https://api.openweathermap.org/geo/1.0/direct?q=$CITY&limit=1&appid=$OWM_KEY" | jq '{ lat: .[0].lat, lon: .[0].lon, city: .[0].local_names.sv }')

LAT=$(echo $LOCATION | jq -r .lat)
LON=$(echo $LOCATION | jq -r .lon)
CITY_PRETTY=$(echo $LOCATION | jq -r .city)

OWM_RESP=$(curl -s -X GET -H "Cache-Control: no-cache" "https://api.openweathermap.org/data/2.5/weather?lon=$LON&lat=$LAT&APPID=$OWM_KEY&units=metric")

WEATHER=$(echo $OWM_RESP | jq -r '.weather[0].main | ascii_downcase')
TEMP=$(echo $OWM_RESP | jq -r '.main.temp | .*10 | round / 10 | tostring')
FEELS=$(echo $OWM_RESP | jq -r '.main.feels_like | .*10 | round / 10 | tostring')
WEATHER_CODE=$(echo $OWM_RESP | jq -r '.weather[0].icon')
EMOJI=$(map_weather_code_to_emoji "$WEATHER_CODE")

DIFF=$(echo "$TEMP - $FEELS" | bc)
ABS_DIFF=$(echo "if ($DIFF < 0) -($DIFF) else $DIFF" | bc)

echo -n -e "It is $(printf "%.1f" "$TEMP")\u00B0c with $WEATHER"

# Only print "feels like" if relevant
if (( $(echo "$ABS_DIFF > 1" | bc -l) )); then
    echo -e " but it feels like $(printf "%.1f" "$FEELS")\u00B0c which is pretty wack"
else
    echo ""
fi


# echo $OWM_RESP | jq

